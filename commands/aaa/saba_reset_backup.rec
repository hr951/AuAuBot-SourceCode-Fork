
const { SlashCommandBuilder, PermissionFlagsBits, ChannelType } = require('discord.js');

module.exports = {
    data: new SlashCommandBuilder()
        .setName('saba_reset')
        .setDescription('ã€ç·Šæ€¥ç”¨ã€‘NukeBotè¢«å®³å¾©æ—§ã®ãŸã‚å…¨ãƒãƒ£ãƒ³ãƒãƒ«ã‚’å‰Šé™¤ãƒ»å†ä½œæˆã—ã¾ã™')
        .addStringOption(option =>
            option.setName('confirmation')
                .setDescription('å®Ÿè¡Œç¢ºèªã®ãŸã‚"RESET_SERVER"ã¨å…¥åŠ›ã—ã¦ãã ã•ã„')
                .setRequired(true))
        .setDefaultMemberPermissions(PermissionFlagsBits.Administrator),

    async execute(interaction) {
        const confirmation = interaction.options.getString('confirmation');

        // ç¢ºèªæ–‡å­—åˆ—ã‚’ãƒã‚§ãƒƒã‚¯
        if (confirmation !== 'RESET_SERVER') {
            await interaction.reply({
                content: 'âš ï¸ **ç¢ºèªæ–‡å­—åˆ—ãŒé–“é•ã£ã¦ã„ã¾ã™**\nå®Ÿè¡Œã™ã‚‹ã«ã¯`RESET_SERVER`ã¨æ­£ç¢ºã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
                ephemeral: true
            });
            return;
        }

        // å®Ÿè¡Œè€…ãŒç®¡ç†è€…æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if (!interaction.member.permissions.has(PermissionFlagsBits.Administrator)) {
            await interaction.reply({
                content: 'âŒ ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ç®¡ç†è€…ã®ã¿å®Ÿè¡Œã§ãã¾ã™ã€‚',
                ephemeral: true
            });
            return;
        }

        await interaction.deferReply();

        const guild = interaction.guild;
        let deletedCount = 0;
        let errorCount = 0;

        try {
            // ç¾åœ¨ã®ãƒãƒ£ãƒ³ãƒãƒ«ã‚’å–å¾—
            const channels = guild.channels.cache.filter(channel => 
                channel.type === ChannelType.GuildText || 
                channel.type === ChannelType.GuildVoice ||
                channel.type === ChannelType.GuildCategory
            );

            await interaction.editReply('ğŸš¨ **ã‚µãƒ¼ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆé–‹å§‹**\nå…¨ãƒãƒ£ãƒ³ãƒãƒ«ã®å‰Šé™¤ã‚’é–‹å§‹ã—ã¾ã™...');

            // å…¨ãƒãƒ£ãƒ³ãƒãƒ«ã‚’å‰Šé™¤
            for (const [, channel] of channels) {
                try {
                    // auau-logãƒãƒ£ãƒ³ãƒãƒ«ã¯ä¿è­·
                    if (channel.name === 'auau-log') {
                        console.log(`auau-logãƒãƒ£ãƒ³ãƒãƒ«ã¯ä¿è­·ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ`);
                        continue;
                    }

                    await channel.delete('NukeBotè¢«å®³å¾©æ—§ã®ãŸã‚å‰Šé™¤');
                    deletedCount++;
                    console.log(`ãƒãƒ£ãƒ³ãƒãƒ« ${channel.name} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);

                    // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’é¿ã‘ã‚‹ãŸã‚å°‘ã—å¾…æ©Ÿ
                    await new Promise(resolve => setTimeout(resolve, 500));
                } catch (error) {
                    console.error(`ãƒãƒ£ãƒ³ãƒãƒ« ${channel.name} ã®å‰Šé™¤ã«å¤±æ•—:`, error);
                    errorCount++;
                }
            }

            await interaction.editReply(
                `ğŸ”„ **ãƒãƒ£ãƒ³ãƒãƒ«å‰Šé™¤å®Œäº†**\n` +
                `å‰Šé™¤æˆåŠŸ: ${deletedCount}å€‹\n` +
                `å‰Šé™¤å¤±æ•—: ${errorCount}å€‹\n\n` +
                `åŸºæœ¬ãƒãƒ£ãƒ³ãƒãƒ«ã‚’å†ä½œæˆä¸­...`
            );

            // åŸºæœ¬ãƒãƒ£ãƒ³ãƒãƒ«ã‚’å†ä½œæˆ
            const basicChannels = [
                { name: 'general', type: ChannelType.GuildText, topic: 'ã‚µãƒ¼ãƒãƒ¼ã®ä¸€èˆ¬ãƒãƒ£ãƒƒãƒˆ' },
                { name: 'announcements', type: ChannelType.GuildText, topic: 'é‡è¦ãªãŠçŸ¥ã‚‰ã›' },
                { name: 'General Voice', type: ChannelType.GuildVoice }
            ];

            let createdCount = 0;

            for (const channelData of basicChannels) {
                try {
                    const newChannel = await guild.channels.create({
                        name: channelData.name,
                        type: channelData.type,
                        topic: channelData.topic || undefined,
                        reason: 'NukeBotè¢«å®³å¾©æ—§ã®ãŸã‚å†ä½œæˆ'
                    });

                    // å¿…è¦ãªãƒ­ãƒ¼ãƒ«ã®æ¨©é™ã‚’è¨­å®š
                    const muteRole = guild.roles.cache.find(role => role.name === 'Muted_AuAu');
                    const raidGuardRole = guild.roles.cache.find(role => role.name === 'RaidGuard_AuAu');
                    const appRestrictRole = guild.roles.cache.find(role => role.name === 'AppRestrict_AuAu');

                    if (muteRole && (channelData.type === ChannelType.GuildText || channelData.type === ChannelType.GuildVoice)) {
                        await newChannel.permissionOverwrites.create(muteRole, {
                            SendMessages: false,
                            Speak: false,
                            AddReactions: false,
                            SendMessagesInThreads: false,
                            CreatePublicThreads: false,
                            CreatePrivateThreads: false,
                        });
                    }

                    if (raidGuardRole && channelData.type === ChannelType.GuildText) {
                        await newChannel.permissionOverwrites.create(raidGuardRole, {
                            SendMessages: false,
                            AddReactions: false,
                            SendMessagesInThreads: false,
                            CreatePublicThreads: false,
                            CreatePrivateThreads: false,
                        });
                    }

                    if (appRestrictRole && channelData.type === ChannelType.GuildText) {
                        await newChannel.permissionOverwrites.create(appRestrictRole, {
                            UseApplicationCommands: false,
                        });
                    }

                    createdCount++;
                    console.log(`åŸºæœ¬ãƒãƒ£ãƒ³ãƒãƒ« ${channelData.name} ã‚’ä½œæˆã—ã¾ã—ãŸ`);

                    await new Promise(resolve => setTimeout(resolve, 300));
                } catch (error) {
                    console.error(`ãƒãƒ£ãƒ³ãƒãƒ« ${channelData.name} ã®ä½œæˆã«å¤±æ•—:`, error);
                }
            }

            // auau-logãƒãƒ£ãƒ³ãƒãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
            let logChannel = guild.channels.cache.find(channel => 
                channel.name === 'auau-log' && channel.type === ChannelType.GuildText
            );

            if (!logChannel) {
                logChannel = await guild.channels.create({
                    name: 'auau-log',
                    type: ChannelType.GuildText,
                    permissionOverwrites: [
                        {
                            id: guild.roles.everyone,
                            deny: ['ViewChannel'],
                        },
                        {
                            id: interaction.client.user.id,
                            allow: ['ViewChannel', 'SendMessages'],
                        },
                    ],
                    reason: 'ã‚µãƒ¼ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆå¾Œã®ãƒ­ã‚°ãƒãƒ£ãƒ³ãƒãƒ«å†ä½œæˆ',
                });
                createdCount++;
                console.log('auau-logãƒãƒ£ãƒ³ãƒãƒ«ã‚’å†ä½œæˆã—ã¾ã—ãŸ');
            }

            await interaction.editReply(
                `âœ… **ã‚µãƒ¼ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆå®Œäº†**\n\n` +
                `ğŸ“Š **å®Ÿè¡Œçµæœ:**\n` +
                `â€¢ å‰Šé™¤ã•ã‚ŒãŸãƒãƒ£ãƒ³ãƒãƒ«: ${deletedCount}å€‹\n` +
                `â€¢ å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${errorCount}å€‹\n` +
                `â€¢ æ–°è¦ä½œæˆã•ã‚ŒãŸãƒãƒ£ãƒ³ãƒãƒ«: ${createdCount}å€‹\n\n` +
                `ğŸ›¡ï¸ **å¾©æ—§çŠ¶æ³:**\n` +
                `â€¢ åŸºæœ¬ãƒãƒ£ãƒ³ãƒãƒ« (general, announcements, General Voice) ã‚’å†ä½œæˆ\n` +
                `â€¢ auau-logãƒãƒ£ãƒ³ãƒãƒ«ã‚’ç¢ºä¿\n` +
                `â€¢ å¿…è¦ãªãƒ­ãƒ¼ãƒ«æ¨©é™ã‚’å†è¨­å®š\n\n` +
                `**æ³¨æ„:** å¿…è¦ã«å¿œã˜ã¦è¿½åŠ ã®ãƒãƒ£ãƒ³ãƒãƒ«ã‚„ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’æ‰‹å‹•ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚`
            );

            // ãƒ­ã‚°ãƒãƒ£ãƒ³ãƒãƒ«ã«è¨˜éŒ²
            if (logChannel) {
                await logChannel.send(
                    `ğŸš¨ **ç·Šæ€¥ã‚µãƒ¼ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ**\n` +
                    `å®Ÿè¡Œè€…: ${interaction.user.username} (${interaction.user.id})\n` +
                    `å®Ÿè¡Œæ™‚é–“: ${new Date().toLocaleString('ja-JP')}\n` +
                    `å‰Šé™¤ãƒãƒ£ãƒ³ãƒãƒ«æ•°: ${deletedCount}å€‹\n` +
                    `å†ä½œæˆãƒãƒ£ãƒ³ãƒãƒ«æ•°: ${createdCount}å€‹\n` +
                    `ç†ç”±: NukeBotè¢«å®³å¾©æ—§`
                );
            }

        } catch (error) {
            console.error('ã‚µãƒ¼ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
            await interaction.editReply(
                `âŒ **ã‚µãƒ¼ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ**\n` +
                `å‰Šé™¤æˆåŠŸ: ${deletedCount}å€‹\n` +
                `ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`
            );
        }
    }
};
